<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript">

    // Load the Visualization API and the piechart package.
    google.load('visualization', '1.0', {'packages':['corechart']});
</script>
<h1>Reporting</h1>
<table class="table table-striped table-bordered table-hover">
  <thead>
    <tr>
      <th colspan="100%">
        <%=@survey.name%>
        <div class="pull-right">
          Total Responses: <%=@complete_surveys.size%>
        </div>
      </th>
    </tr>
  </thead>
  <tbody>
  <% @survey.questions.order(:index).each do |question| %>
    <% if question.rating? or question.yes_no? %>
      <script type="text/javascript">
          // Set a callback to run when the Google Visualization API is loaded.
          google.setOnLoadCallback(drawChart<%=question.id%>);

          // Callback that creates and populates a data table,
          // instantiates the pie chart, passes in the data and
          // draws it.
          function drawChart<%=question.id%>() {

              // Create the data table.
              var data = new google.visualization.DataTable();
              data.addColumn('string', 'Answer');
              data.addColumn('number', 'Visit');
              data.addRows([
                  <% @responses[question.id].each do |k,v|%>
                    ['<%=k.to_s.titleize%>',<%=v%>],
                  <% end %>
              ]);

              // Set chart options
              var options = {'title':'<%=question.text%> (Respondents: <%=(@answers[question.id]/@complete_surveys.size.to_f*100).round(1)%>%)',
                  'width':600,
                  'height':200};

              // Instantiate and draw our chart, passing in some options.
              <%
              chart_type = ''
              if question.rating?
                chart_type = 'PieChart'
              elsif question.yes_no?
                chart_type = 'BarChart'
              end
              %>
              var chart = new google.visualization.<%=chart_type%>(document.getElementById('chart_div<%=question.id%>'));
              chart.draw(data, options);
          }
      </script>
      <!--Div that will hold the chart-->
      <tr>
        <td colspan="100%">
          <div id="chart_div<%=question.id%>"></div>
        </td>
      </tr>
    <% else %>
      <tr>
        <td colspan="100%">
          <%= question.text %>
          <div class="pull-right">
            Respondents: <%=(@answers[question.id]/@complete_surveys.size.to_f*100).round(1)%>%
          </div>
        </td>
      </tr>
      <%@responses[question.id].each do |k,v| %>
        <tr>
          <td></td>
          <td>
            <small>
              <%=v[0]%>
            </small>
          </td>
          <td>
            <%=v[1]%>
          </td>
        </tr>
      <% end %>
    <% end %>
  <% end %>
  </tbody>

</table>